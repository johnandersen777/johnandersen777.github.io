<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=hugo-theme content="Axiom 0.6.8"><link rel=icon type=image/png sizes=32x32 href=/image/brand/favicon.png><link rel=icon type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon href=/image/brand/icon-1-1.png><link rel=canonical href=https://johnandersen777.github.io/wireguard/><link rel=preload as=style href="/bundle.css?v=1729789991" media=all><link rel=stylesheet href="/bundle.css?v=1729789991" media=all><style>.cdata pre{color:#edf2f7;background-color:#2d3748}.cdata :not(pre)>code{color:#805ad5;background-color:#f7fafc}.chroma .err{color:#fed7d7;background-color:#9b2c2c}.chroma .hl{background-color:#4a5568}.chroma .ln{color:#a0aec0}.chroma .k,.chroma .kc,.chroma .kd,.chroma .kn,.chroma .kp,.chroma .kr{color:#63b3ed}.chroma .kt{color:#b794f4}.chroma .na{color:#f6e05e}.chroma .nb{color:#f6ad55}.chroma .nc{color:#fc8181}.chroma .no{color:#68d391}.chroma .nd{color:#fc8181}.chroma .ne{color:#fc8181}.chroma .nf{color:#f6ad55}.chroma .nt{color:#fc8181}.chroma .l{color:#b794f4}.chroma .dl,.chroma .ld,.chroma .s,.chroma .s2,.chroma .sa,.chroma .sb,.chroma .sc,.chroma .sd{color:#68d391}.chroma .se{color:#a0aec0}.chroma .s1,.chroma .sh,.chroma .si,.chroma .sr,.chroma .ss,.chroma .sx{color:#68d391}.chroma .il,.chroma .m,.chroma .mb,.chroma .mf,.chroma .mh,.chroma .mi,.chroma .mo{color:#b794f4}.chroma .o,.chroma .ow{color:#90cdf4}.chroma .p{color:#cbd5e0}.chroma .c,.chroma .c1,.chroma .ch,.chroma .cm,.chroma .cp,.chroma .cpf,.chroma .cs{color:#a0aec0}.chroma .ge{font-style:italic}.chroma .gs{font-weight:700}</style><title>Wireguard HowTo : johnandersen777's blog</title><meta property="og:title" content="Wireguard HowTo"><meta property="og:site_name" content="johnandersen777's blog"><meta property="og:url" content="https://johnandersen777.github.io/wireguard/"><link rel=image_src href=https://johnandersen777.github.io/image/page-default.webp><meta property="og:image" content="https://johnandersen777.github.io/image/page-default.webp"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="og:type" content="article"><meta property="og:locale" content="en_us"><meta property="og:description" content="Wireguard is a VPN that comes built into Linux kernels &amp;gt;= 5.6 It also has clients for OSs like Windows, OSX, and Android. If you're looking for how to have a virtual LAN party, Wireguard is a great way to do it."><meta name=description content="Wireguard is a VPN that comes built into Linux kernels &amp;gt;= 5.6 It also has clients for OSs like Windows, OSX, and Android. If you're looking for how to have a virtual LAN party, Wireguard is a great way to do it."><meta property="og:updated_time" content="2020-07-24T06:00:00Z"><meta property="fb:app_id" content><meta name=author content="John Andersen"><meta property="article:author" content="https://johnandersen777.github.io/"><meta property="article:published_time" content="2020-07-24T06:00:00Z"><meta property="article:modified_time" content="2020-07-24T06:00:00Z"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","headline":"Wireguard HowTo","alternativeHeadline":"How to use Linux's built in peer to peer VPN","url":"https://johnandersen777.github.io/wireguard/","image":"https://johnandersen777.github.io/image/page-default.webp","mainEntityOfPage":{"@type":"WebPage","@id":"https://johnandersen777.github.io/wireguard/"},"description":"Wireguard is a VPN that comes built into Linux kernels \u0026gt;= 5.6 It also has clients for OSs like Windows, OSX, and Android. If you're looking for how to have a virtual LAN party, Wireguard is a great way to do it.","author":{"@type":"Person","name":"John Andersen"},"publisher":{"@type":"Organization","name":"johnandersen777's blog","logo":{"@type":"ImageObject","url":"https://johnandersen777.github.io/image/brand/icon-1-1.png"}},"datePublished":"2020-07-24T06:00:00Z","dateModified":"2020-07-24T06:00:00Z","articleBody":"\u003cp\u003eWireguard is a VPN that comes built into Linux kernels \u0026gt;= 5.6\nIt also has clients for OSs like Windows, OSX, and Android.\u003c/p\u003e\n\u003cp\u003eIf you're looking for how to have a virtual LAN party, Wireguard\nis a great way to do it. Since it's cross platform. You can even\nplay Windows games on Linux using Lutris and network them with\nWireguard to get Windows and Linux machines playing together.\u003c/p\u003e\n\u003ch2 id=\"checking-if-you-have-it\"\u003eChecking If You Have It\u003c/h2\u003e\n\u003cp\u003eTo check if you're Linux distro already has wireguard support,\nlook in the modules directory.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eMy version at the moment is \u003ccode\u003e5.6.4-152.current\u003c/code\u003e, yours will\nlikely be different\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cpre\u003e\u003ccode class=\"language-console\" data-lang=\"console\"\u003e$ find /lib/modules/$(uname -r) -type f -name '*wireguard*.ko*'\n/lib/modules/5.6.4-152.current/kernel/drivers/net/wireguard/wireguard.ko\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eIf that doesn't show anything then check if it's built into the\nkernel. This command will show some output if it is. On my system\nit's a \u003ccode\u003e.ko\u003c/code\u003e, therefore it's not builtin, therefore this command\nshowed nothing.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-console\" data-lang=\"console\"\u003e$ grep wireguard /lib/modules/$(uname -r)/modules.builtin\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eYou'll also need the \u003ccode\u003ewg\u003c/code\u003e command line utility. Just type \u003ccode\u003ewg\u003c/code\u003e and\nif you see command not found then you'll want to head over to\n\u003ca href=\"https://www.wireguard.com/install/\"\u003ehttps://www.wireguard.com/install/\u003c/a\u003e for details on how to install it.\u003c/p\u003e\n\u003ch2 id=\"getting-it\"\u003eGetting It\u003c/h2\u003e\n\u003cp\u003eIf you don't have a version of the Linux kernel with wireguard\nbuilt in, you can compile and use the\n\u003ca href=\"https://git.zx2c4.com/wireguard-go/about/\"\u003ewireguard-go\u003c/a\u003e project.\nIt won't be as fast as compiling the kernel module but it might be\na hell of a lot less steps.\u003c/p\u003e\n\u003cp\u003eIf you don't want to take the performance hit, you can compile the\nkernel module as seen in the\n\u003ca href=\"https://www.wireguard.com/compilation/\"\u003ecompilation\u003c/a\u003e instructions.\u003c/p\u003e\n\u003cp\u003eYou'll build it, then add it to the kernel with \u003ccode\u003einsmod\u003c/code\u003e.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-console\" data-lang=\"console\"\u003e$ sudo insmod wireguard-linux-compat/src/wireguard.ko\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eCheck \u003ccode\u003edmesg\u003c/code\u003e, if you see complaints about missing symbols,\nyou can recompile those modules that are missing, as seen\nunder kernel requirements. You'll want to find out how your\nLinux distribution recommends compiling the kernel. This is\nbecause many of them have patches that your system won't\nwork without added to the kernel. You might be able to run\nthe kernel from kernel.org, but don't count on that.\u003c/p\u003e\n\u003ch2 id=\"configuring-it\"\u003eConfiguring It\u003c/h2\u003e\n\u003cp\u003eThe following is an example config file one might use.\nThere are comments within it to explain everything.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"c1\"\u003e# The Interface section is for defining things about this\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# machine\u003c/span\u003e\n\u003cspan class=\"k\"\u003e[Interface]\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# The port wireguard will listen on for others to use as\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# and Endpoint (along with this machines IP)\u003c/span\u003e\n\u003cspan class=\"na\"\u003eListenPort\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e60200\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# On Windows when you click Add Tunnel it will generate\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# a private key for you. On Linux you\u0026#39;ll want to put the\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# output of `wg genkey` here.\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# The config files of the other machines in the network\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# will need the public key that correseponds to this private\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# key. On Windows it will show you the public key in a little\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# box under the config file name when it\u0026#39;s being edited. On\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# Linux, you can run the following command to parse this file\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# to get the private key and convert it into the public key\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# $ grep \u0026#39;PrivateKey = \u0026#39; wg.conf | tail -n 1 | sed -e \u0026#39;s/.* = //g\u0026#39; | wg pubkey\u003c/span\u003e\n\u003cspan class=\"na\"\u003ePrivateKey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003eREPLACE_WITH_PRIVATE_KEY\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# On Windows you\u0026#39;ll want to specify the address for the\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# machine like by removing the # in front. The setup.sh\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# script that follows parses it out of this config file\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# and uses it as your address. For Linux the wg tool will\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# tell you there\u0026#39;s an error if you uncomment it.\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# You\u0026#39;ll want to make sure you leave this as /24 and\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# the other addresses as /32. See the References section\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# for more details on this.\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# Address = 192.168.4.4/24\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# Each time you have a new compuer you want to connect to\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# it\u0026#39;ll need it\u0026#39;s own [Peer] section.\u003c/span\u003e\n\u003cspan class=\"k\"\u003e[Peer]\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# You\u0026#39;ll want to specify the public key of the machine\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# you want to connect to. The person with the config file\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# of the machine you\u0026#39;re trying to connect to needs to run\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# the command with `wg pubkey` in the comment above PrivateKey\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# to get their public key. They then should share it with you\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# over some secure medium of communication, ideally end to\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# end encrypted. If it gets tampered with, your wireguard\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# connection is no longer secure.\u003c/span\u003e\n\u003cspan class=\"na\"\u003ePublicKey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e4QEX7I58pR5PaZNmDI2wmnsT/HvvFBkNc5wZJ00scXw==\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# You\u0026#39;ll want to put the IP that the other machine will be\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# accessible at here. This is the value they have as Address\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# under the [Interface] section of their wg.conf\u003c/span\u003e\n\u003cspan class=\"na\"\u003eAllowedIPs\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e192.168.4.115/32\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# If the person has a server they\u0026#39;re running wireguard on and\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# has exposed their ListenPort then that goes here. If another\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# person has used their home router and port forwarded then\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# that also can be used. The IP address here is the IP address\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# of the machine as it is on the publicly addressable Internet,\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# not your friends IP on their home network. This can be found by\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# typing into Google, what\u0026#39;s my IP, or using canihazip.com\u003c/span\u003e\n\u003cspan class=\"na\"\u003eEndpoint\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e76.115.24.198:43022\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# This is used to make sure the connection stays alive.\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# It says to send a heartbeat / ping to the Endpoint every\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# 25 seconds\u003c/span\u003e\n\u003cspan class=\"na\"\u003ePersistentKeepalive\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e25\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# Keep adding peers as you wish. At a minimum you\u0026#39;ll need to\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# add their public key and their address\u003c/span\u003e\n\u003cspan class=\"k\"\u003e[Peer]\u003c/span\u003e\n\u003cspan class=\"na\"\u003ePublicKey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e3StsslOTQlqMnd42UaKi9FdNu9GSTLi1WCaqwg8lkhc=\u003c/span\u003e\n\u003cspan class=\"na\"\u003eAllowedIPs\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e192.168.4.3/32\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIf we wanted to setup a network where all machines would have\n192.168.4.XXX addresses, we could do it as follows.\u003c/p\u003e\n\u003cp\u003eFirst, copy the example config file into a file named \u003ccode\u003ewg.conf\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eYou'll want to generate a new private key and add it to the file.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-console\" data-lang=\"console\"\u003e$ sed -i \u0026quot;s#REPLACE_WITH_PRIVATE_KEY#$(wg genkey)#\u0026quot; wg.conf\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eYou need to get your public key from your private key.\nThe following command parses the private key out of the\nconfig file and generates the corresponding public key.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-console\" data-lang=\"console\"\u003e$ grep 'PrivateKey = ' wg.conf | tail -n 1 | sed -e 's/.* = //g' | wg pubkey\nrR7O5IvIq16RpntAqZCNmTd42nsI6Mq5139XMYwZ5hQ=\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThe output of this command is the public key which will\nbe used in one of the \u003ccode\u003e[Peer]\u003c/code\u003e sections in the config of\nthe other machines in your new wireguard network. It will\nchange whenever you regenerate the private key and replace\nit in the config file.\u003c/p\u003e\n\u003cp\u003eYou should communicate with the other people you're trying\nto set up your new wireguard network with to make sure you\nall choose a different IP address for the line that has\n\u003ccode\u003eAddress = \u003c/code\u003e. On Windows you'll need to uncomment that line.\nIn the \u003ca href=\"#using-it\"\u003eUsing It\u003c/a\u003e section there will be a \u003ccode\u003esetup.sh\u003c/code\u003e\nscript, On Linux the script will parse the comment and use it\nas your IP address within the wireguard network, do not\nuncomment that line on Linux.\u003c/p\u003e\n\u003cp\u003eYou can parse your config file to get your chosen address\nusing the following command.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-console\" data-lang=\"console\"\u003e$ cat \u0026quot;${conf}\u0026quot;| grep 'Address = ' | sed -e 's/.* = //g' -e 's/\\/24//g'\n192.168.4.4\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eIn this case, our machine will appear in the config file\nof the other machines as follows\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"k\"\u003e[Peer]\u003c/span\u003e\n\u003cspan class=\"na\"\u003ePublicKey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003erR7O5IvIq16RpntAqZCNmTd42nsI6Mq5139XMYwZ5hQ=\u003c/span\u003e\n\u003cspan class=\"na\"\u003eAllowedIPs\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e192.168.4.4/32\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIf you have the \u003ccode\u003eListenPort\u003c/code\u003e exposed to the public internet,\nvia port forwarding or via firewall rules (or both). Then the\npeer section for your machine in the config files of the other\npeople in your network will include the \u003ccode\u003eEndpoint\u003c/code\u003e and optionally\nthe \u003ccode\u003ePersistentKeepalive\u003c/code\u003e properties.\u003c/p\u003e\n\u003cp\u003eYou can find your IP by running\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-console\" data-lang=\"console\"\u003e$ curl -s -w '\\n' https://canihazip.com/s\n24.21.101.158\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThe corresponding \u003ccode\u003e[Peer]\u003c/code\u003e section in other peoples configs\nwould then be the following.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-ini\" data-lang=\"ini\"\u003e\u003cspan class=\"k\"\u003e[Peer]\u003c/span\u003e\n\u003cspan class=\"na\"\u003ePublicKey\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003erR7O5IvIq16RpntAqZCNmTd42nsI6Mq5139XMYwZ5hQ=\u003c/span\u003e\n\u003cspan class=\"na\"\u003eAllowedIPs\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e192.168.4.4/32\u003c/span\u003e\n\u003cspan class=\"na\"\u003eEndpoint\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e24.21.101.158:60200\u003c/span\u003e\n\u003cspan class=\"na\"\u003ePersistentKeepalive\u003c/span\u003e \u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s\"\u003e25\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"using-it\"\u003eUsing It\u003c/h2\u003e\n\u003cp\u003eIf you're using wireguard-go you'll want to run it in a separate\nterminal before running the \u003ccode\u003esetup.sh\u003c/code\u003e script. This command tells\nwireguard-go to create a new wireguard interface called wg0.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-console\" data-lang=\"console\"\u003e$ wireguard-go -f wg0\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eIf you're using wireguard-go you'll want to run this export\ncommand in the same terminal you're going to run \u003ccode\u003esetup.sh\u003c/code\u003e\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-console\" data-lang=\"console\"\u003e$ export WGGO=1\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eHere is the script you can name \u003ccode\u003esetup.sh\u003c/code\u003e to use to setup a\nsimple wireguard network.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre class=\"chroma\"\u003e\u003ccode class=\"language-bash\" data-lang=\"bash\"\u003e\u003cspan class=\"cp\"\u003e#!/usr/bin/env bash\n\u003c/span\u003e\u003cspan class=\"cp\"\u003e\u003c/span\u003e\u003cspan class=\"c1\"\u003e# Usage: sudo bash setup.sh wg.conf\u003c/span\u003e\n\u003cspan class=\"nb\"\u003eset\u003c/span\u003e -xe\n\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;x\u003c/span\u003e\u003cspan class=\"nv\"\u003e$UID\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e !\u003cspan class=\"o\"\u003e=\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;x0\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n  \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;You must be root to run this.\u0026#34;\u003c/span\u003e\n  \u003cspan class=\"nb\"\u003eexit\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# Check that the first argument is a file\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e -f \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003e1\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e# Set the conf variable to the first argument\u003c/span\u003e\n  \u003cspan class=\"nv\"\u003econf\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003e1\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003cspan class=\"k\"\u003eelse\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e# If it isn\u0026#39;t a file then complain\u003c/span\u003e\n  \u003cspan class=\"nb\"\u003eecho\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;Usage: sudo bash \u003c/span\u003e\u003cspan class=\"nv\"\u003e$0\u003c/span\u003e\u003cspan class=\"s2\"\u003e wg.conf\u0026#34;\u003c/span\u003e\n  \u003cspan class=\"nb\"\u003eexit\u003c/span\u003e \u003cspan class=\"m\"\u003e1\u003c/span\u003e\n\u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# If you are using wireguard-go\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# export WGGO=1\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# before running this. You\u0026#39;ll have to create the\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# interface a different way described later\u003c/span\u003e\n\u003cspan class=\"k\"\u003eif\u003c/span\u003e \u003cspan class=\"o\"\u003e[\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;x\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eWGGO\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e==\u003c/span\u003e \u003cspan class=\"s2\"\u003e\u0026#34;x\u0026#34;\u003c/span\u003e \u003cspan class=\"o\"\u003e]\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003ethen\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e# Remove existing interface if it exists\u003c/span\u003e\n  ip link del dev wg0 2\u0026gt;/dev/null \u003cspan class=\"o\"\u003e||\u003c/span\u003e \u003cspan class=\"nb\"\u003etrue\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e# Create a new wireguard interface\u003c/span\u003e\n  ip link add dev wg0 \u003cspan class=\"nb\"\u003etype\u003c/span\u003e wireguard\n\u003cspan class=\"k\"\u003efi\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# Parse out our IP from the config file\u003c/span\u003e\n\u003cspan class=\"nv\"\u003eour_ip\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003ecat \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003econf\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e|\u003c/span\u003e grep \u003cspan class=\"s1\"\u003e\u0026#39;Address = \u0026#39;\u003c/span\u003e \u003cspan class=\"p\"\u003e|\u003c/span\u003e sed -e \u003cspan class=\"s1\"\u003e\u0026#39;s/.* = //g\u0026#39;\u003c/span\u003e -e \u003cspan class=\"s1\"\u003e\u0026#39;s/\\/24//g\u0026#39;\u003c/span\u003e\u003cspan class=\"k\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# Tell Linux that our IP for the wireguard interface is the\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# one we paresed out from the Address line in the config file\u003c/span\u003e\nip address add \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"nv\"\u003e$our_ip\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e/24 dev wg0\n\n\u003cspan class=\"c1\"\u003e# Grab a list of our peers IPs by parsing every line\u003c/span\u003e\n\u003cspan class=\"c1\"\u003e# with AllowedIPs in the config file\u003c/span\u003e\n\u003cspan class=\"nv\"\u003epeers\u003c/span\u003e\u003cspan class=\"o\"\u003e=\u003c/span\u003e\u003cspan class=\"k\"\u003e$(\u003c/span\u003ecat \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003econf\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"p\"\u003e|\u003c/span\u003e grep AllowedIPs \u003cspan class=\"p\"\u003e|\u003c/span\u003e sed -e \u003cspan class=\"s1\"\u003e\u0026#39;s/.* = //g\u0026#39;\u003c/span\u003e -e \u003cspan class=\"s1\"\u003e\u0026#39;s/\\/32//g\u0026#39;\u003c/span\u003e\u003cspan class=\"k\"\u003e)\u003c/span\u003e\n\n\u003cspan class=\"k\"\u003efor\u003c/span\u003e addr in \u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003epeers\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"p\"\u003e;\u003c/span\u003e \u003cspan class=\"k\"\u003edo\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e# Tell Linux that it can find our peers using the\u003c/span\u003e\n  \u003cspan class=\"c1\"\u003e# interface we added\u003c/span\u003e\n  ip address add dev wg0 \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eour_ip\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e peer \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003eaddr\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\u003cspan class=\"k\"\u003edone\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# Tell wireguard to use our config file\u003c/span\u003e\nwg setconf wg0 \u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\u003cspan class=\"si\"\u003e${\u003c/span\u003e\u003cspan class=\"nv\"\u003econf\u003c/span\u003e\u003cspan class=\"si\"\u003e}\u003c/span\u003e\u003cspan class=\"s2\"\u003e\u0026#34;\u003c/span\u003e\n\n\u003cspan class=\"c1\"\u003e# Turn on the interface\u003c/span\u003e\nip link \u003cspan class=\"nb\"\u003eset\u003c/span\u003e up dev wg0\n\n\u003cspan class=\"c1\"\u003e# Show the configured interface\u003c/span\u003e\nip addr show wg0\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eMake sure your config files are all correct, and then run\nthe script as root. The following example of running the\nscript includes sample output.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"language-console\" data-lang=\"console\"\u003e$ sudo bash setup.sh wg.conf\n+ '[' x0 '!=' x0 ']'\n+ '[' -f wg.conf ']'\n+ conf=wg.conf\n+ '[' x == x ']'\n+ ip link del dev wg0\n+ ip link add dev wg0 type wireguard\n++ cat wg.conf\n++ sed -e 's/.* = //g' -e 's/\\/24//g'\n++ grep 'Address = '\n+ our_ip=192.168.4.4\n+ ip address add 192.168.4.4/24 dev wg0\n++ cat wg.conf\n++ sed -e 's/.* = //g' -e 's/\\/32//g'\n++ grep AllowedIPs\n+ peers='192.168.4.115\n192.168.4.3'\n+ for addr in ${peers}\n+ ip address add dev wg0 192.168.4.4 peer 192.168.4.115\n+ for addr in ${peers}\n+ ip address add dev wg0 192.168.4.4 peer 192.168.4.3\n+ wg setconf wg0 wg.conf\n+ ip link set up dev wg0\n+ ip addr show wg0\n25: wg0: \u0026lt;POINTOPOINT,NOARP,UP,LOWER_UP\u0026gt; mtu 1420 qdisc noqueue state UNKNOWN group default qlen 1000\n    link/none\n    inet 192.168.4.4/24 scope global wg0\n       valid_lft forever preferred_lft forever\n    inet 192.168.4.4 peer 192.168.4.115/32 scope global wg0\n       valid_lft forever preferred_lft forever\n    inet 192.168.4.4 peer 192.168.4.3/32 scope global wg0\n       valid_lft forever preferred_lft forever\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eOn Windows, you'll just save the config file and click Activate.\u003c/p\u003e\n\u003cp\u003eOnce everyone has run the script or activated the config (for\nWindows). Then you can try pinging the other hosts.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eYou may not be able to ping some Windows machines. But they\nwill be able to ping you. So try the reverse when it's not\nworking.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cpre\u003e\u003ccode class=\"language-console\" data-lang=\"console\"\u003e$ ping 192.168.4.3\nPING 192.168.4.3 (192.168.4.3): 56 data bytes\n64 bytes from 192.168.4.3: icmp_seq=0 ttl=128 time=3.197 ms\n64 bytes from 192.168.4.3: icmp_seq=1 ttl=128 time=3.617 ms\n64 bytes from 192.168.4.3: icmp_seq=2 ttl=128 time=37.290 ms\n64 bytes from 192.168.4.3: icmp_seq=3 ttl=128 time=3.504 ms\n64 bytes from 192.168.4.3: icmp_seq=4 ttl=128 time=3.626 ms\n64 bytes from 192.168.4.3: icmp_seq=5 ttl=128 time=37.651 ms\n64 bytes from 192.168.4.3: icmp_seq=6 ttl=128 time=3.461 ms\n^C--- 192.168.4.3 ping statistics ---\n7 packets transmitted, 7 packets received, 0% packet loss\nround-trip min/avg/max/stddev = 3.197/13.192/37.651/15.356 ms\n\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"gotchas\"\u003eGotchas\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eIf you see \u003ccode\u003eping: sending packet: Destination address required\u003c/code\u003e.\nIt's likely that everyone need to check their configs to make\nsure that everyone elses public keys are correct.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThe Windows client takes an \u003ccode\u003eAddress\u003c/code\u003e parameter that's used as the\nIP address for the machine running that config. You'll need to\nuncomment it.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://www.wireguard.com/quickstart/\"\u003ehttps://www.wireguard.com/quickstart/\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://blog.jessfraz.com/post/installing-and-using-wireguard/\"\u003ehttps://blog.jessfraz.com/post/installing-and-using-wireguard/\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eExample of using the demo server\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eScripts that run the wireguard demo server\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://git.zx2c4.com/wireguard-tools/tree/contrib/ncat-client-server\"\u003ehttps://git.zx2c4.com/wireguard-tools/tree/contrib/ncat-client-server\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing#IPv4_CIDR_blocks\"\u003ehttps://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing#IPv4_CIDR_blocks\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eThe reason we do \u003ccode\u003e/32\u003c/code\u003e behind all the IPs of our peers is because\nit means there is only 1 address in that block, that one address\nis the address of our peer (the one preceding the \u003ccode\u003e/\u003c/code\u003e)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://en.wikipedia.org/wiki/Private_network#Private_IPv4_addresses\"\u003ehttps://en.wikipedia.org/wiki/Private_network#Private_IPv4_addresses\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eIf you have more than 255 peers you want to connect then you'll\nwant to change the \u003ccode\u003e/24\u003c/code\u003e to something appropriate. You'll have to\nread this and the previous link to figure out what you should use.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e"}</script><link rel=preload as=script href="/bundle.js?v=1729789991"><link rel=preconnect href=https://www.google-analytics.com><link rel=preconnect href=https://stats.g.doubleclick.net><link rel=preconnect href=https://www.googleadservices.com><link rel=preload as=script href="https://www.googletagmanager.com/gtag/js?id=UA-160259978-2"><script src="https://www.googletagmanager.com/gtag/js?id=UA-160259978-2"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
gtag('js',new Date());gtag('config','UA-160259978-2');</script></head><body><header id=nav class=header><div class="ax-l-i max-w-6xl"><div class=ax-logo><a class=block href=/ title="johnandersen777's blog"><img src=/images/avatar2x.png alt="johnandersen777's blog"></a></div><div class=ax-user><a class="p-2 w-8 h-8 block text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" target=_blank rel="noopener nofollow" href="https://www.google.com/search?q=site:johnandersen777.github.io" title=Search><svg class="fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M2.67 12.804c0-5.6 4.544-10.134 10.133-10.134s10.134 4.544 10.134 10.134-4.544 10.133-10.134 10.133S2.67 18.393 2.67 12.804zm28.943 16.923-8.868-8.868c4.287-5.3 3.68-13.012-1.378-17.57S8.564-1.066 3.75 3.75s-5.017 12.558-.46 17.618 12.28 5.665 17.57 1.378l8.868 8.868a1.33 1.33.0 002.231-.597c.123-.46-.008-.952-.345-1.29h0z"/></svg></a><a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href=/posts/>Posts</a>
<a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href=/about/>About</a>
<a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href=/theres_something_rotten_with_the_state_of_eden/#todos>⏳</a>
<a class="p-2 block text-base leading-none text-raven-500 hover:text-gray-800 focus:text-gray-800 focus:outline-none" href=/a_guide_to_good/>💊</a></div></div></header><main><div class=default-single><div class="ax-title ax-l-o"><div class="ax-l-i max-w-680"><h1 class="post-title font-content-title font-normal leading-tight tracking-default text-40">Wireguard HowTo</h1><p class="post-subtitle font-content-sans font-light text-xl text-raven-500 mt-3">How to use Linux's built in peer to peer VPN</p><div class="ax-meta flex items-center mt-5"><div class="flex-grow min-w-0"><div class="flex items-center"><div class=flex-shrink-0><img class="w-12 h-12 sm:w-14 sm:h-14 object-cover p-05 rounded-full border border-blue-300" src=/images/avatar@2x.png alt="John Andersen"></div><div class="flex-shrink-0 ml-2 leading-tight font-content-sans"><a class="block text-sm text-raven-800 hover:text-raven-900 hover:underline focus:underline" target=_blank rel="noopener nofollow" title="John Andersen" href=https://johnandersen777.github.io/>John Andersen</a>
<time class="text-sm text-raven-500" datetime=2020-07-24T06:00:00Z>Jul 24, 2020 6:00AM</time></div></div></div><div><div class="flex items-center"><a class="flex-shrink-0 block text-raven-800 hover:text-raven-900" target=_blank rel="noopener nofollow" title="Share on Twitter" href="https://twitter.com/intent/tweet?text=Wireguard%20HowTo%20by%20%40johnandersen777%20https%3a%2f%2fjohnandersen777.github.io%2fwireguard%2f"><svg class="w-6 h-6 fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11.0 01-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56.0 00-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57.0 002.914 5.452 6.48 6.48.0 01-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42.0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57a13.18 13.18.0 01-8.134 2.798c-.538.0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072.0 18.672-10 18.672-18.668.0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg></a><a class="ml-3 flex-shrink-0 block text-raven-800 hover:text-raven-900" target=_blank rel="noopener nofollow" title="Share on Facebook" href="https://www.facebook.com/dialog/share?app_id=&display=page&href=https%3a%2f%2fjohnandersen777.github.io%2fwireguard%2f"><svg class="w-6 h-6 fill-current" viewBox="-7 -3.5 39 39" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M30.234.0H1.765C.8.001.0.79.0 1.766v28.47C.001 31.2.79 32 1.766 32h15.328V19.625h-4.156V14.78h4.156v-3.564c0-4.134 2.523-6.384 6.21-6.384 1.766.0 3.284.13 3.726.2v4.32h-2.543c-2.006.0-2.394.953-2.394 2.352v3.085h4.797l-.625 4.844h-4.172V32h8.14C31.21 32 32 31.2 32 30.234V1.765C32 .8 31.21.0 30.234.0z"/></svg></a></div></div></div></div></div><div class="ax-content ax-l-o"><div class="ax-l-i max-w-680"><article class=cdata><p>Wireguard is a VPN that comes built into Linux kernels >= 5.6
It also has clients for OSs like Windows, OSX, and Android.</p><p>If you're looking for how to have a virtual LAN party, Wireguard
is a great way to do it. Since it's cross platform. You can even
play Windows games on Linux using Lutris and network them with
Wireguard to get Windows and Linux machines playing together.</p><h2 id=checking-if-you-have-it>Checking If You Have It</h2><p>To check if you're Linux distro already has wireguard support,
look in the modules directory.</p><blockquote><p>My version at the moment is <code>5.6.4-152.current</code>, yours will
likely be different</p></blockquote><pre><code class=language-console data-lang=console>$ find /lib/modules/$(uname -r) -type f -name '*wireguard*.ko*'
/lib/modules/5.6.4-152.current/kernel/drivers/net/wireguard/wireguard.ko
</code></pre><p>If that doesn't show anything then check if it's built into the
kernel. This command will show some output if it is. On my system
it's a <code>.ko</code>, therefore it's not builtin, therefore this command
showed nothing.</p><pre><code class=language-console data-lang=console>$ grep wireguard /lib/modules/$(uname -r)/modules.builtin
</code></pre><p>You'll also need the <code>wg</code> command line utility. Just type <code>wg</code> and
if you see command not found then you'll want to head over to
<a href=https://www.wireguard.com/install/>https://www.wireguard.com/install/</a> for details on how to install it.</p><h2 id=getting-it>Getting It</h2><p>If you don't have a version of the Linux kernel with wireguard
built in, you can compile and use the
<a href=https://git.zx2c4.com/wireguard-go/about/>wireguard-go</a> project.
It won't be as fast as compiling the kernel module but it might be
a hell of a lot less steps.</p><p>If you don't want to take the performance hit, you can compile the
kernel module as seen in the
<a href=https://www.wireguard.com/compilation/>compilation</a> instructions.</p><p>You'll build it, then add it to the kernel with <code>insmod</code>.</p><pre><code class=language-console data-lang=console>$ sudo insmod wireguard-linux-compat/src/wireguard.ko
</code></pre><p>Check <code>dmesg</code>, if you see complaints about missing symbols,
you can recompile those modules that are missing, as seen
under kernel requirements. You'll want to find out how your
Linux distribution recommends compiling the kernel. This is
because many of them have patches that your system won't
work without added to the kernel. You might be able to run
the kernel from kernel.org, but don't count on that.</p><h2 id=configuring-it>Configuring It</h2><p>The following is an example config file one might use.
There are comments within it to explain everything.</p><div class=highlight><pre class=chroma><code class=language-ini data-lang=ini><span class=c1># The Interface section is for defining things about this</span>
<span class=c1># machine</span>
<span class=k>[Interface]</span>
<span class=c1># The port wireguard will listen on for others to use as</span>
<span class=c1># and Endpoint (along with this machines IP)</span>
<span class=na>ListenPort</span> <span class=o>=</span> <span class=s>60200</span>
<span class=c1># On Windows when you click Add Tunnel it will generate</span>
<span class=c1># a private key for you. On Linux you&#39;ll want to put the</span>
<span class=c1># output of `wg genkey` here.</span>
<span class=c1># The config files of the other machines in the network</span>
<span class=c1># will need the public key that correseponds to this private</span>
<span class=c1># key. On Windows it will show you the public key in a little</span>
<span class=c1># box under the config file name when it&#39;s being edited. On</span>
<span class=c1># Linux, you can run the following command to parse this file</span>
<span class=c1># to get the private key and convert it into the public key</span>
<span class=c1># $ grep &#39;PrivateKey = &#39; wg.conf | tail -n 1 | sed -e &#39;s/.* = //g&#39; | wg pubkey</span>
<span class=na>PrivateKey</span> <span class=o>=</span> <span class=s>REPLACE_WITH_PRIVATE_KEY</span>
<span class=c1># On Windows you&#39;ll want to specify the address for the</span>
<span class=c1># machine like by removing the # in front. The setup.sh</span>
<span class=c1># script that follows parses it out of this config file</span>
<span class=c1># and uses it as your address. For Linux the wg tool will</span>
<span class=c1># tell you there&#39;s an error if you uncomment it.</span>
<span class=c1># You&#39;ll want to make sure you leave this as /24 and</span>
<span class=c1># the other addresses as /32. See the References section</span>
<span class=c1># for more details on this.</span>
<span class=c1># Address = 192.168.4.4/24</span>

<span class=c1># Each time you have a new compuer you want to connect to</span>
<span class=c1># it&#39;ll need it&#39;s own [Peer] section.</span>
<span class=k>[Peer]</span>
<span class=c1># You&#39;ll want to specify the public key of the machine</span>
<span class=c1># you want to connect to. The person with the config file</span>
<span class=c1># of the machine you&#39;re trying to connect to needs to run</span>
<span class=c1># the command with `wg pubkey` in the comment above PrivateKey</span>
<span class=c1># to get their public key. They then should share it with you</span>
<span class=c1># over some secure medium of communication, ideally end to</span>
<span class=c1># end encrypted. If it gets tampered with, your wireguard</span>
<span class=c1># connection is no longer secure.</span>
<span class=na>PublicKey</span> <span class=o>=</span> <span class=s>4QEX7I58pR5PaZNmDI2wmnsT/HvvFBkNc5wZJ00scXw==</span>
<span class=c1># You&#39;ll want to put the IP that the other machine will be</span>
<span class=c1># accessible at here. This is the value they have as Address</span>
<span class=c1># under the [Interface] section of their wg.conf</span>
<span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>192.168.4.115/32</span>
<span class=c1># If the person has a server they&#39;re running wireguard on and</span>
<span class=c1># has exposed their ListenPort then that goes here. If another</span>
<span class=c1># person has used their home router and port forwarded then</span>
<span class=c1># that also can be used. The IP address here is the IP address</span>
<span class=c1># of the machine as it is on the publicly addressable Internet,</span>
<span class=c1># not your friends IP on their home network. This can be found by</span>
<span class=c1># typing into Google, what&#39;s my IP, or using canihazip.com</span>
<span class=na>Endpoint</span> <span class=o>=</span> <span class=s>76.115.24.198:43022</span>
<span class=c1># This is used to make sure the connection stays alive.</span>
<span class=c1># It says to send a heartbeat / ping to the Endpoint every</span>
<span class=c1># 25 seconds</span>
<span class=na>PersistentKeepalive</span> <span class=o>=</span> <span class=s>25</span>

<span class=c1># Keep adding peers as you wish. At a minimum you&#39;ll need to</span>
<span class=c1># add their public key and their address</span>
<span class=k>[Peer]</span>
<span class=na>PublicKey</span> <span class=o>=</span> <span class=s>3StsslOTQlqMnd42UaKi9FdNu9GSTLi1WCaqwg8lkhc=</span>
<span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>192.168.4.3/32</span>
</code></pre></div><p>If we wanted to setup a network where all machines would have
192.168.4.XXX addresses, we could do it as follows.</p><p>First, copy the example config file into a file named <code>wg.conf</code>.</p><p>You'll want to generate a new private key and add it to the file.</p><pre><code class=language-console data-lang=console>$ sed -i &quot;s#REPLACE_WITH_PRIVATE_KEY#$(wg genkey)#&quot; wg.conf
</code></pre><p>You need to get your public key from your private key.
The following command parses the private key out of the
config file and generates the corresponding public key.</p><pre><code class=language-console data-lang=console>$ grep 'PrivateKey = ' wg.conf | tail -n 1 | sed -e 's/.* = //g' | wg pubkey
rR7O5IvIq16RpntAqZCNmTd42nsI6Mq5139XMYwZ5hQ=
</code></pre><p>The output of this command is the public key which will
be used in one of the <code>[Peer]</code> sections in the config of
the other machines in your new wireguard network. It will
change whenever you regenerate the private key and replace
it in the config file.</p><p>You should communicate with the other people you're trying
to set up your new wireguard network with to make sure you
all choose a different IP address for the line that has
<code>Address = </code>. On Windows you'll need to uncomment that line.
In the <a href=#using-it>Using It</a> section there will be a <code>setup.sh</code>
script, On Linux the script will parse the comment and use it
as your IP address within the wireguard network, do not
uncomment that line on Linux.</p><p>You can parse your config file to get your chosen address
using the following command.</p><pre><code class=language-console data-lang=console>$ cat &quot;${conf}&quot;| grep 'Address = ' | sed -e 's/.* = //g' -e 's/\/24//g'
192.168.4.4
</code></pre><p>In this case, our machine will appear in the config file
of the other machines as follows</p><div class=highlight><pre class=chroma><code class=language-ini data-lang=ini><span class=k>[Peer]</span>
<span class=na>PublicKey</span> <span class=o>=</span> <span class=s>rR7O5IvIq16RpntAqZCNmTd42nsI6Mq5139XMYwZ5hQ=</span>
<span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>192.168.4.4/32</span>
</code></pre></div><p>If you have the <code>ListenPort</code> exposed to the public internet,
via port forwarding or via firewall rules (or both). Then the
peer section for your machine in the config files of the other
people in your network will include the <code>Endpoint</code> and optionally
the <code>PersistentKeepalive</code> properties.</p><p>You can find your IP by running</p><pre><code class=language-console data-lang=console>$ curl -s -w '\n' https://canihazip.com/s
24.21.101.158
</code></pre><p>The corresponding <code>[Peer]</code> section in other peoples configs
would then be the following.</p><div class=highlight><pre class=chroma><code class=language-ini data-lang=ini><span class=k>[Peer]</span>
<span class=na>PublicKey</span> <span class=o>=</span> <span class=s>rR7O5IvIq16RpntAqZCNmTd42nsI6Mq5139XMYwZ5hQ=</span>
<span class=na>AllowedIPs</span> <span class=o>=</span> <span class=s>192.168.4.4/32</span>
<span class=na>Endpoint</span> <span class=o>=</span> <span class=s>24.21.101.158:60200</span>
<span class=na>PersistentKeepalive</span> <span class=o>=</span> <span class=s>25</span>
</code></pre></div><h2 id=using-it>Using It</h2><p>If you're using wireguard-go you'll want to run it in a separate
terminal before running the <code>setup.sh</code> script. This command tells
wireguard-go to create a new wireguard interface called wg0.</p><pre><code class=language-console data-lang=console>$ wireguard-go -f wg0
</code></pre><p>If you're using wireguard-go you'll want to run this export
command in the same terminal you're going to run <code>setup.sh</code></p><pre><code class=language-console data-lang=console>$ export WGGO=1
</code></pre><p>Here is the script you can name <code>setup.sh</code> to use to setup a
simple wireguard network.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/usr/bin/env bash
</span><span class=cp></span><span class=c1># Usage: sudo bash setup.sh wg.conf</span>
<span class=nb>set</span> -xe

<span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;x</span><span class=nv>$UID</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=s2>&#34;x0&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
  <span class=nb>echo</span> <span class=s2>&#34;You must be root to run this.&#34;</span>
  <span class=nb>exit</span> <span class=m>1</span>
<span class=k>fi</span>

<span class=c1># Check that the first argument is a file</span>
<span class=k>if</span> <span class=o>[</span> -f <span class=s2>&#34;</span><span class=si>${</span><span class=nv>1</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
  <span class=c1># Set the conf variable to the first argument</span>
  <span class=nv>conf</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=nv>1</span><span class=si>}</span><span class=s2>&#34;</span>
<span class=k>else</span>
  <span class=c1># If it isn&#39;t a file then complain</span>
  <span class=nb>echo</span> <span class=s2>&#34;Usage: sudo bash </span><span class=nv>$0</span><span class=s2> wg.conf&#34;</span>
  <span class=nb>exit</span> <span class=m>1</span>
<span class=k>fi</span>

<span class=c1># If you are using wireguard-go</span>
<span class=c1># export WGGO=1</span>
<span class=c1># before running this. You&#39;ll have to create the</span>
<span class=c1># interface a different way described later</span>
<span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;x</span><span class=si>${</span><span class=nv>WGGO</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;x&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
  <span class=c1># Remove existing interface if it exists</span>
  ip link del dev wg0 2&gt;/dev/null <span class=o>||</span> <span class=nb>true</span>
  <span class=c1># Create a new wireguard interface</span>
  ip link add dev wg0 <span class=nb>type</span> wireguard
<span class=k>fi</span>

<span class=c1># Parse out our IP from the config file</span>
<span class=nv>our_ip</span><span class=o>=</span><span class=k>$(</span>cat <span class=s2>&#34;</span><span class=si>${</span><span class=nv>conf</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>|</span> grep <span class=s1>&#39;Address = &#39;</span> <span class=p>|</span> sed -e <span class=s1>&#39;s/.* = //g&#39;</span> -e <span class=s1>&#39;s/\/24//g&#39;</span><span class=k>)</span>

<span class=c1># Tell Linux that our IP for the wireguard interface is the</span>
<span class=c1># one we paresed out from the Address line in the config file</span>
ip address add <span class=s2>&#34;</span><span class=nv>$our_ip</span><span class=s2>&#34;</span>/24 dev wg0

<span class=c1># Grab a list of our peers IPs by parsing every line</span>
<span class=c1># with AllowedIPs in the config file</span>
<span class=nv>peers</span><span class=o>=</span><span class=k>$(</span>cat <span class=s2>&#34;</span><span class=si>${</span><span class=nv>conf</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>|</span> grep AllowedIPs <span class=p>|</span> sed -e <span class=s1>&#39;s/.* = //g&#39;</span> -e <span class=s1>&#39;s/\/32//g&#39;</span><span class=k>)</span>

<span class=k>for</span> addr in <span class=si>${</span><span class=nv>peers</span><span class=si>}</span><span class=p>;</span> <span class=k>do</span>
  <span class=c1># Tell Linux that it can find our peers using the</span>
  <span class=c1># interface we added</span>
  ip address add dev wg0 <span class=s2>&#34;</span><span class=si>${</span><span class=nv>our_ip</span><span class=si>}</span><span class=s2>&#34;</span> peer <span class=s2>&#34;</span><span class=si>${</span><span class=nv>addr</span><span class=si>}</span><span class=s2>&#34;</span>
<span class=k>done</span>

<span class=c1># Tell wireguard to use our config file</span>
wg setconf wg0 <span class=s2>&#34;</span><span class=si>${</span><span class=nv>conf</span><span class=si>}</span><span class=s2>&#34;</span>

<span class=c1># Turn on the interface</span>
ip link <span class=nb>set</span> up dev wg0

<span class=c1># Show the configured interface</span>
ip addr show wg0
</code></pre></div><p>Make sure your config files are all correct, and then run
the script as root. The following example of running the
script includes sample output.</p><pre><code class=language-console data-lang=console>$ sudo bash setup.sh wg.conf
+ '[' x0 '!=' x0 ']'
+ '[' -f wg.conf ']'
+ conf=wg.conf
+ '[' x == x ']'
+ ip link del dev wg0
+ ip link add dev wg0 type wireguard
++ cat wg.conf
++ sed -e 's/.* = //g' -e 's/\/24//g'
++ grep 'Address = '
+ our_ip=192.168.4.4
+ ip address add 192.168.4.4/24 dev wg0
++ cat wg.conf
++ sed -e 's/.* = //g' -e 's/\/32//g'
++ grep AllowedIPs
+ peers='192.168.4.115
192.168.4.3'
+ for addr in ${peers}
+ ip address add dev wg0 192.168.4.4 peer 192.168.4.115
+ for addr in ${peers}
+ ip address add dev wg0 192.168.4.4 peer 192.168.4.3
+ wg setconf wg0 wg.conf
+ ip link set up dev wg0
+ ip addr show wg0
25: wg0: &lt;POINTOPOINT,NOARP,UP,LOWER_UP&gt; mtu 1420 qdisc noqueue state UNKNOWN group default qlen 1000
    link/none
    inet 192.168.4.4/24 scope global wg0
       valid_lft forever preferred_lft forever
    inet 192.168.4.4 peer 192.168.4.115/32 scope global wg0
       valid_lft forever preferred_lft forever
    inet 192.168.4.4 peer 192.168.4.3/32 scope global wg0
       valid_lft forever preferred_lft forever
</code></pre><p>On Windows, you'll just save the config file and click Activate.</p><p>Once everyone has run the script or activated the config (for
Windows). Then you can try pinging the other hosts.</p><blockquote><p>You may not be able to ping some Windows machines. But they
will be able to ping you. So try the reverse when it's not
working.</p></blockquote><pre><code class=language-console data-lang=console>$ ping 192.168.4.3
PING 192.168.4.3 (192.168.4.3): 56 data bytes
64 bytes from 192.168.4.3: icmp_seq=0 ttl=128 time=3.197 ms
64 bytes from 192.168.4.3: icmp_seq=1 ttl=128 time=3.617 ms
64 bytes from 192.168.4.3: icmp_seq=2 ttl=128 time=37.290 ms
64 bytes from 192.168.4.3: icmp_seq=3 ttl=128 time=3.504 ms
64 bytes from 192.168.4.3: icmp_seq=4 ttl=128 time=3.626 ms
64 bytes from 192.168.4.3: icmp_seq=5 ttl=128 time=37.651 ms
64 bytes from 192.168.4.3: icmp_seq=6 ttl=128 time=3.461 ms
^C--- 192.168.4.3 ping statistics ---
7 packets transmitted, 7 packets received, 0% packet loss
round-trip min/avg/max/stddev = 3.197/13.192/37.651/15.356 ms
</code></pre><h2 id=gotchas>Gotchas</h2><ul><li><p>If you see <code>ping: sending packet: Destination address required</code>.
It's likely that everyone need to check their configs to make
sure that everyone elses public keys are correct.</p></li><li><p>The Windows client takes an <code>Address</code> parameter that's used as the
IP address for the machine running that config. You'll need to
uncomment it.</p></li></ul><h2 id=references>References</h2><ul><li><p><a href=https://www.wireguard.com/quickstart/>https://www.wireguard.com/quickstart/</a></p></li><li><p><a href=https://blog.jessfraz.com/post/installing-and-using-wireguard/>https://blog.jessfraz.com/post/installing-and-using-wireguard/</a></p><ul><li>Example of using the demo server</li></ul></li><li><p>Scripts that run the wireguard demo server</p><ul><li><a href=https://git.zx2c4.com/wireguard-tools/tree/contrib/ncat-client-server>https://git.zx2c4.com/wireguard-tools/tree/contrib/ncat-client-server</a></li></ul></li><li><p><a href=https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing#IPv4_CIDR_blocks>https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing#IPv4_CIDR_blocks</a></p><ul><li>The reason we do <code>/32</code> behind all the IPs of our peers is because
it means there is only 1 address in that block, that one address
is the address of our peer (the one preceding the <code>/</code>)</li></ul></li><li><p><a href=https://en.wikipedia.org/wiki/Private_network#Private_IPv4_addresses>https://en.wikipedia.org/wiki/Private_network#Private_IPv4_addresses</a></p><ul><li>If you have more than 255 peers you want to connect then you'll
want to change the <code>/24</code> to something appropriate. You'll have to
read this and the previous link to figure out what you should use.</li></ul></li></ul></article></div></div></div></main><footer class=footer><div class="ax-l-i max-w-6xl"><nav class="flex items-center justify-center"><a class="ml-3 first:ml-0 text-sm text-gray-600 hover:text-gray-800" href=/posts/>Posts</a>
<a class="ml-3 first:ml-0 text-sm text-gray-600 hover:text-gray-800" href=/about/>About</a>
<a class="ml-3 first:ml-0 text-sm text-gray-600 hover:text-gray-800" href=/theres_something_rotten_with_the_state_of_eden/#todos>⏳</a>
<a class="ml-3 first:ml-0 text-sm text-gray-600 hover:text-gray-800" href=/a_guide_to_good/>💊</a></nav><div class="footer-social flex items-center justify-center mt-4"><a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target=_blank rel="noopener nofollow" title=Twitter href=https://mastodon.social/@johnandersen777><svg class="fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M32 6.078c-1.2.522-2.458.868-3.78 1.036 1.36-.812 2.398-2.088 2.886-3.626a13.11 13.11.0 01-4.16 1.588C25.742 3.794 24.026 3 22.154 3a6.56 6.56.0 00-6.556 6.562c0 .52.044 1.02.152 1.496-5.454-.266-10.28-2.88-13.522-6.862-.566.982-.898 2.106-.898 3.316a6.57 6.57.0 002.914 5.452 6.48 6.48.0 01-2.964-.808v.072c0 3.188 2.274 5.836 5.256 6.446-.534.146-1.116.216-1.72.216-.42.0-.844-.024-1.242-.112.85 2.598 3.262 4.508 6.13 4.57a13.18 13.18.0 01-8.134 2.798c-.538.0-1.054-.024-1.57-.1C2.906 27.93 6.35 29 10.064 29c12.072.0 18.672-10 18.672-18.668.0-.3-.01-.57-.024-.848C30.014 8.56 31.108 7.406 32 6.078z"/></svg></a><a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target=_blank rel="noopener nofollow" title=Github href=https://github.com/johnandersen777><svg class="fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M15.998.0C7.164.0.0 7.35.0 16.417.0 23.67 4.584 29.82 10.944 31.994c.8.15 1.092-.356 1.092-.79l-.022-2.792c-4.45.99-5.4-2.202-5.4-2.202-.726-1.896-1.776-2.4-1.776-2.4-1.454-1.018.108-.998.108-.998 1.606.117 2.45 1.693 2.45 1.693 1.428 2.507 3.746 1.784 4.658 1.363.144-1.06.558-1.784 1.016-2.195-3.552-.415-7.288-1.823-7.288-8.113.0-1.792.624-3.258 1.648-4.406-.166-.415-.714-2.085.156-4.344.0.0 1.344-.44 4.4 1.683 1.276-.364 2.644-.546 4.006-.552a14.98 14.98.0 014.006.554C23.062 6.37 24.404 6.8 24.404 6.8c.872 2.26.324 3.93.16 4.344 1.026 1.148 1.644 2.614 1.644 4.406.0 6.306-3.74 7.694-7.304 8.1.574.507 1.086 1.51 1.086 3.04l-.02 4.503c0 .44.288.95 1.1.788C27.42 29.817 32 23.667 32 16.417 32 7.35 24.836.0 15.998.0z"/></svg></a><a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target=_blank rel="noopener nofollow" title=Youtube href=https://www.youtube.com/@dffml9083/playlists><svg class="fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M30.64 7.12c-.868-1.544-1.8-1.828-3.728-1.936C24.996 5.054 20.178 5 16.004 5c-4.182.0-9.002.054-10.916.182-1.914.1-2.858.392-3.734 1.938C.46 8.662.0 11.318.0 15.994V16c0 4.656.46 7.332 1.354 8.858.876 1.544 1.818 1.824 3.732 1.954 1.916.112 6.736.178 10.918.178 4.174.0 8.992-.066 10.9-.176 1.918-.13 2.86-.4 3.728-1.954.902-1.526 1.358-4.202 1.358-8.858v-.016c0-4.678-.456-7.334-1.36-8.876zM12 22V10l10 6-10 6z"/></svg></a><a class="block mx-3 w-6 h-6 text-raven-700 hover:text-raven-900" target=_blank rel="noopener nofollow" title=LinkedIn href=https://www.linkedin.com/in/john-andersen-7a72b555/><svg class="fill-current" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M29.692.0H2.308A2.31 2.31.0 000 2.308v27.384A2.31 2.31.0 002.308 32h27.384A2.31 2.31.0 0032 29.692V2.308A2.31 2.31.0 0029.692.0zM11.35 24.188H7.454V12.464h3.897v11.723zM9.402 10.863h-.025c-1.308.0-2.153-.9-2.153-2.025.0-1.15.872-2.026 2.205-2.026s2.153.875 2.18 2.026c0 1.125-.846 2.025-2.205 2.025zm16 13.324h-3.896v-6.272c0-1.576-.564-2.65-1.974-2.65-1.076.0-1.717.725-2 1.425-.103.25-.128.6-.128.95v6.547h-3.896V12.464h3.896v1.66c.518-.8 1.444-1.935 3.512-1.935 2.564.0 4.486 1.676 4.486 5.276v6.722z"/></svg></a></div><div class="footer-copyright text-sm text-center text-gray-500 mt-4">&#169; 2016-2024 johnandersen777's blog</div><div class="text-sm sm:text-xs text-center text-gray-500 mt-2">Powered by <a href="https://www.axiomtheme.com/?utm_source=theme-footer&utm_medium=website&utm_campaign=referral">Axiom</a></div></div></footer><script src="/bundle.js?v=1729789991"></script></body></html>